---
import BaseLayout from "../layouts/BaseLayout.astro";
import Icon from "../components/Icon.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
---

<BaseLayout
  title="Feedback | My Portfolio"
  description="Share your feedback about my portfolio"
>
  <Header />
  <div class="max-w-2xl w-full mx-auto">
    <section id="feedback" class="section py-7 md:py-14">
      <div class="container-custom">
        <div class="section-header">
          <h2 class="section-title">Feedback</h2>
          <p class="section-subtitle">
            Your feedback helps me improve. Share your thoughts!
          </p>
        </div>

        <!-- Feedback Form -->
        <form
          action="https://api.web3forms.com/submit"
          method="POST"
          id="feedbackForm"
          class="bg-gh-canvas-subtle border border-border-default rounded-xl p-5"
        >
          <input
            type="hidden"
            name="access_key"
            value={import.meta.env.PUBLIC_WEB3FORMS_ACCESS_KEY}
          />
          <input type="checkbox" class="hidden" name="botcheck" />
          <input type="hidden" name="subject" value="New Portfolio Feedback" />

          <!-- Rating Section -->
          <div class="mb-6">
            <label class="block text-lg mb-3 text-gh-fg-default">
              How do you feel about my portfolio?
            </label>
            <div class="grid grid-cols-4 gap-2 sm:gap-5">
              <label
                class="rating-option flex flex-col items-center gap-2"
                data-color="danger"
              >
                <input
                  type="radio"
                  name="rating"
                  value="Hate it"
                  class="sr-only"
                />
                <div
                  class="rating-card cursor-pointer flex items-center justify-center p-2 sm:p-4 hover:text-gh-danger-fg bg-canvas-subtle border-2 border-border-default rounded-full transition-all hover:border-border-muted aspect-square w-14 h-14 sm:w-20 sm:h-20"
                >
                  <Icon
                    name="smiley-frustrated"
                    size={24}
                    class="sm:w-8 sm:h-8"
                  />
                </div>
                <div
                  class="text-xs sm:text-sm font-medium text-gh-fg-muted pointer-events-none"
                >
                  Hate it
                </div>
              </label>

              <label
                class="rating-option flex flex-col items-center gap-2"
                data-color="attention"
              >
                <input
                  type="radio"
                  name="rating"
                  value="Not great"
                  class="sr-only"
                />
                <div
                  class="rating-card cursor-pointer flex items-center justify-center p-2 sm:p-4 hover:text-gh-attention-fg bg-canvas-subtle border-2 border-border-default rounded-full transition-all hover:border-border-muted aspect-square w-14 h-14 sm:w-20 sm:h-20"
                >
                  <Icon name="smiley-frown" size={24} class="sm:w-8 sm:h-8" />
                </div>
                <div
                  class="text-xs sm:text-sm font-medium text-gh-fg-muted pointer-events-none"
                >
                  Not great
                </div>
              </label>

              <label
                class="rating-option flex flex-col items-center gap-2"
                data-color="accent"
              >
                <input
                  type="radio"
                  name="rating"
                  value="It's ok"
                  class="sr-only"
                />
                <div
                  class="rating-card cursor-pointer flex items-center justify-center p-2 sm:p-4 hover:text-gh-accent-fg bg-canvas-subtle border-2 border-border-default rounded-full transition-all hover:border-border-muted aspect-square w-14 h-14 sm:w-20 sm:h-20"
                >
                  <Icon name="smiley" size={24} class="sm:w-8 sm:h-8" />
                </div>
                <div
                  class="text-xs sm:text-sm font-medium text-gh-fg-muted pointer-events-none"
                >
                  It's ok
                </div>
              </label>

              <label
                class="rating-option flex flex-col items-center gap-2"
                data-color="success"
              >
                <input
                  type="radio"
                  name="rating"
                  value="Love it"
                  class="sr-only"
                />
                <div
                  class="rating-card cursor-pointer flex items-center justify-center p-2 sm:p-4 hover:text-gh-success-fg bg-canvas-subtle border-2 border-border-default rounded-full transition-all hover:border-border-muted aspect-square w-14 h-14 sm:w-20 sm:h-20"
                >
                  <Icon name="smiley-grin" size={24} class="sm:w-8 sm:h-8" />
                </div>
                <div
                  class="text-xs sm:text-sm font-medium text-gh-fg-muted pointer-events-none"
                >
                  Love it
                </div>
              </label>
            </div>
          </div>

          <!-- Message Field -->
          <div class="mb-6">
            <label for="message" class="block text-lg mb-2 text-fg-default">
              Your feedback <span class="text-gh-danger-fg">*</span>
            </label>
            <textarea
              id="message"
              name="message"
              required
              placeholder="Share your feedback & suggestions hereâ€¦"
              class="w-full px-4 py-3 bg-canvas-subtle border border-border-default placeholder:text-fg-muted rounded-lg outline-none h-48 transition-all resize-y text-fg-default bg-gh-canvas-inset"
            ></textarea>
          </div>

          <div class="flex gap-2.5 justify-end">
            <button
              type="reset"
              class="w-fit text-base text-gh-fg-muted hover:text-gh-fg-default px-3 py-2 btn hidden"
              id="resetBtn"
            >
              Clear
            </button>
            <button
              type="submit"
              class="w-fit text-base px-3 py-2 btn btn-primary"
            >
              <Icon name="rocket" size={16} class="w-5 h-5" />
              Send Feedback
            </button>
          </div>

          <!-- Result Message -->
          <div id="result" class="mt-4 text-center"></div>
        </form>
      </div>
    </section>
  </div>
  <Footer />

  <style>
    .rating-option[data-color="danger"] input:checked ~ .rating-card {
      border-color: var(--gh-danger-fg);
      color: var(--gh-danger-fg);
    }

    .rating-option[data-color="attention"] input:checked ~ .rating-card {
      border-color: var(--gh-attention-fg);
      color: var(--gh-attention-fg);
    }

    .rating-option[data-color="accent"] input:checked ~ .rating-card {
      border-color: var(--gh-accent-fg);
      color: var(--gh-accent-fg);
    }

    .rating-option[data-color="success"] input:checked ~ .rating-card {
      border-color: var(--gh-success-fg);
      color: var(--gh-success-fg);
    }

    .rating-option input:checked ~ div:last-child {
      color: inherit;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }
  </style>

  <script is:inline>
    document.addEventListener(
      "DOMContentLoaded",
      () => {
        const form = document.getElementById("feedbackForm");
        const result = document.getElementById("result");

        // Fix header navigation links
        const headerLinks = document.querySelectorAll('header a[href^="#"]');
        headerLinks.forEach((link) => {
          link.addEventListener("click", (e) => {
            e.preventDefault();
            const targetId = link.getAttribute("href").substring(1);
            window.location.href = "/#" + targetId;
          });
        });

        form.addEventListener("input", () => {
          const clearBtn = document.getElementById("resetBtn");
          clearBtn.classList.remove("hidden");
        });

        form.addEventListener("reset", () => {
          const clearBtn = document.getElementById("resetBtn");
          clearBtn.classList.add("hidden");
        });

        form.addEventListener("submit", async function (e) {
          e.preventDefault();

          if (!form.checkValidity()) {
            return;
          }

          const formData = new FormData(form);
          const json = JSON.stringify(Object.fromEntries(formData));

          result.style.display = "";
          result.innerHTML = "Sending...";
          result.className = "mt-4 text-center text-slate-400";

          try {
            const response = await fetch("https://api.web3forms.com/submit", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
              },
              body: json,
            });

            const data = await response.json();

            if (response.status === 200) {
              result.classList.remove("text-slate-400");
              result.classList.add("text-gh-success-fg");
              result.innerHTML = "Thank you for your feedback!";

              // Redirect to home page after showing success message
              setTimeout(() => {
                window.location.href = "/";
              }, 2000);
            } else {
              result.classList.remove("text-slate-400");
              result.classList.add("text-gh-danger-fg");
              result.innerHTML = data.message;
            }
          } catch (error) {
            result.classList.remove("text-slate-400");
            result.classList.add("text-gh-danger-fg");
            result.innerHTML = "Something went wrong!";
          } finally {
            form.reset();
            const clearBtn = document.getElementById("resetBtn");
            clearBtn.classList.add("hidden");
            // Remove the setTimeout that hides the result message on error
            if (result.classList.contains("text-gh-danger-fg")) {
              setTimeout(() => {
                result.style.display = "none";
              }, 5000);
            }
          }
        });
      },
      { once: true },
    );
  </script>
</BaseLayout>
